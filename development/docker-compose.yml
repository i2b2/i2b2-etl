# Copyright 2023 Massachusetts General Hospital.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


version: '3.5'


services:
    i2b2-etl:
        image: i2b2/i2b2-etl:${I2B2_ETL_TAG}
        environment:
          - CRC_DB_HOST=${I2B2_DS_CRC_IP}
          - CRC_DB_PORT=${I2B2_DS_CRC_PORT}
          - CRC_DB_USER=${I2B2_DS_CRC_USER}
          - CRC_DB_PASS=${I2B2_DS_CRC_PASS}
          - CRC_DB_NAME=${I2B2_DS_CRC_DB}
          - CRC_DB_TYPE=${I2B2_DS_CRC_DB_TYPE}

          - ONT_DB_HOST=${I2B2_DS_ONT_IP}
          - ONT_DB_PORT=${I2B2_DS_ONT_PORT}
          - ONT_DB_USER=${I2B2_DS_ONT_USER}
          - ONT_DB_PASS=${I2B2_DS_ONT_PASS}
          - ONT_DB_NAME=${I2B2_DS_ONT_DB}
          - ONT_DB_TYPE=${I2B2_DS_ONT_DB_TYPE}
            
          - PM_DB_HOST=${I2B2_DS_PM_IP}
          - PM_DB_PASS=${I2B2_DS_PM_PASS}
          - PM_DB_USER=${I2B2_DS_PM_USER}
          - PM_DB_PORT=${I2B2_DS_PM_PORT}
          - PM_DB_NAME=${I2B2_DS_PM_DB}
          - PM_DB_TYPE=${I2B2_DS_PM_DB_TYPE}

          - HIVE_DB_HOST=${I2B2_DS_HIVE_IP}
          - HIVE_DB_PORT=${I2B2_DS_HIVE_PORT}
          - HIVE_DB_USER=${I2B2_DS_HIVE_USER}
          - HIVE_DB_PASS=${I2B2_DS_HIVE_PASS}
          - HIVE_DB_NAME=${I2B2_DS_HIVE_DB}
          - HIVE_DB_TYPE=${I2B2_DS_HIVE_DB_TYPE}

          - BCP_DELIMITER=${I2B2_DS_BCP_DELIMITER}
          - DB_USER=${I2B2_DS_USER}
          - DB_PASS=${I2B2_DS_PASSWORD}
          - INSTITUTION_NAME=${INSTITUTION_NAME}
          - INSTITUTION_LOGO_URL=${INSTITUTION_LOGO_URL}
          - I2B2_PM_SERVICE_URL=${I2B2_PM_SERVICE_URL}
          - MRN_HASH_SALT=${MRN_HASH_SALT}
          - ENABLE_PATIENT_FACT=${ENABLE_PATIENT_FACT}
          
        container_name: i2b2-etl
        stdin_open: true
        tty: true   
        volumes:
            - ../:/usr/src/app
            - /tmp:/tmp
        ports:
            - 5000:5000
        networks:
            - i2b2-net
        command: bash -c "                       
                     python -m i2b2_cdi project upgrade 
                    &&  python -m i2b2_cdi project password -c etl-pgsql.env --user demo --password $I2B2_ROOT_PASSWORD
                    &&  python -m i2b2_cdi project password -c etl-pgsql.env --user i2b2 --password $I2B2_ROOT_PASSWORD
                    &&  python -m i2b2_cdi project add --project-name test1 --project-user-password Test@123 
                    &&  python -m i2b2_cdi.loader.i2b2_cdi_app"

networks:
    i2b2-net:
        name: i2b2-net
        driver: bridge